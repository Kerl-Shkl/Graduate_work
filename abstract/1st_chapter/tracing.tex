%! TEX root = ../main.tex

\section{Трассировка}
Трассировка~--- последовательное выполнение программы, при котором после каждой
инструкции управление передается отладчику. В этом режиме программист может
детально отследить изменения значений всех параметров процесса. Обеспечение
режима пошагового выполнения программы предусмотрено на аппаратном уровне.

В процессоре (\textbf{TODO} каком) есть регистр флагов (EFLAGS), который состоит
из 32 бит, каждый из которых отображает состояние процессора (рис.
\ref{fig:eflags}).
\begin{figure}[htpb]
  \centering
  \includegraphics[width=0.8\textwidth]{eflags.jpg}
  \caption{Регистр флагов процессора}
  \label{fig:eflags}
\end{figure}

Восьмой из них является флагом трассировки (trap flag). Если этот флаг равен 1,
то процессор будет выполнять прерывание типа 1 после каждой инструкции. При
выполнении прерывания 1 процессор выполняет передачу управления в обработчик
прерывания, который помещает состояние всех регистров процессора в стек после
чего предает необходимую информацию отладчику. Обработчик прерывания в конце
своей работы может либо оставить флаг трассировки равным 1, либо перевести его
значение в 0.

Пример установки флага трассировки:
\begin{verbatim}
  pushf                    ; Помещаем регистр флагов в стек
  mov EBP, ESP             ; Сохраняем адрес вершины стека
  or  WORD PTR[EBP], 0100h ; Устанавливаем флаг TF
  popf                     ; Восстанавливаем регистр флагов
\end{verbatim}
Соответственно, чтобы снять флаг трассировки достаточно заменить инструкцию
\verb!OR! на инструкцию:
\begin{verbatim}
  and  WORD PTR[EBP], FEFFh
\end{verbatim}

Таким образом, можем заметить, что при проведении трассировки исходный код
отлаживаемой программы никак не меняется.
