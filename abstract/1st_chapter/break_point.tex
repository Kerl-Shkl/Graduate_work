%! TEX root = ../main.tex

\section{Точки останова}
Точка останова~--- место в коде программы, дойдя до которого, процессор должен
прервать выполнение программы и передать управление отладчику. После этого
программист может просмотреть параметры состояния программы, поставить или
убрать другие точки останова или запустить трассировку. Точки останова бывают
двух типов: программные и аппаратные.

Рассмотрим принцип работы каждой из них.

\subsection{Программные точки останова}
Программные точки останова реализованы следующим образом. Когда программист
ставит точку останова на какой-либо инструкции, отладчик запоминает данную
инструкцию в своей памяти, а затем заменяет данную инструкцию на 
\begin{verbatim}
  int 3 ; Генерация программного прерывания
\end{verbatim}
Таким образом, когда процессор доходит до данной инструкции, возбуждается
прерывание, управление переходит в обработчик прерывания, откуда затем
информация передается в отладчик. 

Инструкция \verb!int 3! имеет специальный однобайтовый код операции
(\verb!0xCC!), в то время как, обычно прерывания имеют двухбайтовый код
операции: \verb!int x!~$\to$~\verb!0xCD x!. Это связано с тем, что может
потребоваться заменить в коде однобайтовую операцию, например команду инкремента
\verb!inc!. В таком случае, если бы инструкция замены была больше одного
байта, то повреждалась бы следующая инструкция. Это в свою очередь накладывает
дополнительные расходы в ситуации, когда требуется из точки останова произвести
трассировку.

Как видно, установка программной точки останова изменяет исходный код
программы.

\subsection{Аппаратные точки останова}
В архитектуре x86 есть шесть регистров, предназначенных специально для отладки.
Именуются они \verb!DR0..DR7!, при этом регистры \verb!DR4! и \verb!DR5! не
используются. Данные регистры позволяют устанавливать точки останова с
различными условиями. Также они являются привилегированным ресурсом,
следовательно инструкции, устанавливающие данные регистры, могут выполняться
только с нулевого уровня защиты.

Регистры с \verb!DR0! по \verb!D3! содержат линейные адреса точек останова,
каждая из которых связана с условием остановки. Условия определены в регистре
\verb!DR7!.

В регистре \verb!DR6! содержится статус отладки. Он позволяет отладчику
определить, какие условия отладки возникли. Первые четыре бита указывают, какая
из четырех точек останова в регистрах \verb!DR0..DR3! сработала. Бит 13
указывает, что следующая инструкция обращается к регистрам отладки. Бит 14
указывает на пошаговое выполнение (включает Trap Flag в регистре EFLAGS). 

Регистр \verb!DR7! предназначен для управления процессом отладки, он позволяет
выборочно включать условия остановки для точек останова в регистрах
\verb!DR0..DR3!. Есть два режима включения регистра: локальный (биты 0, 2, 4,
6) и глобальный (биты 1, 3, 5, 7). При локальном включении процессор сбрасывает
условия остановки при каждом переключении задачи. При глобальном включении
условия остановки не сбрасываются, а следовательно они используются для всех
задач. Биты 17:16; 21:20; 25:24 и 29:28 позволяют установить следующие условия
срабатывания точек останова:
\begin{itemize}
  \item \verb!00b! --- При выполнении инструкции.
  \item \verb!01b! --- При записи данных.
  \item \verb!10b! --- При обращении к порту ввода/вывода.
  \item \verb!11b! --- Чтение и запись данных.
\end{itemize}

Как можно заметить, установка аппаратных точек останова никак не меняет исходный
код программы.
