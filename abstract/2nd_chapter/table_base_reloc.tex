%! TEX root = ../main.tex

\section{Таблица базовых релокаций}

Как отмечалось ранее, операционная система Windows использует механизм ASLR.
ASLR (Address space layout randomization) --- это метод компьютерной
безопасности предназначенный для предотвращения использования уязвимостей,
связанных с повреждением памяти. Таким образом можно предотвратить простой
переход злоумышленника, например, к конкретной функции в памяти. ASLR случайным
образом упорядочивает позиции адресного пространства ключевых областей данных
процесса, включая базовый адрес загрузки, позиции стека, кучи и загружаемых
библиотек.

Из вышеизложенного следует, что адреса конкретных функций и переменных
невозможно определить до запуска программы. Следовательно, должен быть механизм
корректировки адресов в различных секциях программы. Например, необходимо
изменить все абсолютный адреса из инструкций \verb!jmp! в соответствии с
конкретным базовым адресом.

В системе Windows для этого в каждом исполняемом файле, который поддерживает
ASLR, есть таблица базовых релокаций. При помощи этой таблицы загрузчик
приложений Windows скорректировать участки программы в соответствии с адресом
загрузки.

Таблица базовых релокаций содержит записи для всех исправлений в образе
программы. Общий размер таблицы содержится в опциональном заголовке. Вся таблица
разбита на блоки исправлений. Каждый блок содержит исправления для страницы
размера 4Кбайт и выровнен по 32-битной границе. 

Каждый блок исправлений начинается со структуры описанной в таблице
\ref{tab:fixup_block}.

\begin{table}[h!]
  \centering
  \begin{tabularx} {\textwidth} {
      | >{\raggedright \arraybackslash \hsize=.17\hsize}X 
      | >{\arraybackslash \hsize=.13\hsize}X
      | >{\arraybackslash \hsize=.25\hsize}X
      | >{\arraybackslash \hsize=.45\hsize}X|
    } 
    \hline 
    \textbf{Смещение} & \textbf{Размер} & \textbf{Поле} & \textbf{Значение} \\
    \hline 
    0 & 4 & Относительный виртуальный адрес страницы &
      Базовый адрес загрузки плюс относительный виртуальный адрес
      страницы прибавляется к каждому смещению в таблице, чтобы получить
      виртуальный адрес по которому необходимо провести исправление \\
    \hline
    4 & 4 & Размер блока исправлений &
      Общее количество байтов, занимаемых блоком исправлений, включая эту
      структуру.\\
    \hline
  \end{tabularx}  
  \caption{Структура блока исправлений}
  \label{tab:fixup_block}
\end{table}

После описанной структуры следуют поля таблицы. Каждое поле занимает 2 байта и
имеет структуру, описанную в таблицы \ref{tab:fixup_field}.

\begin{table}[h!]
  \centering
  \begin{tabularx}{\textwidth}{
      | >{\raggedright \arraybackslash \hsize=.17\hsize}X 
      | >{\raggedright \arraybackslash \hsize=.13\hsize}X
      | >{\arraybackslash \hsize=.25\hsize}X
      | >{\arraybackslash \hsize=.45\hsize}X|
    } 
    \hline
    \textbf{Смещение} & \textbf{Размер} & \textbf{Поле} & \textbf{Значение} \\
    \hline
    0 & 4 бита & Тип & Размещенное в старших четырех битах слова значение
    указывает на тип исправления. Всего типов исправлений может быть 16, каждый
    тип указывает, как необходимо провести коррекцию значения в памяти. \\
    \hline
    0 & 12 бит & Смещение & Размещенное в младших двенадцати битах слова
    значение указывает смещение относительно относительного виртуального адреса
    страницы. Это смещение указывает место, где необходимо произвести
    коррекцию. \\ 
    \hline
  \end{tabularx}
  \caption{Структура поля таблицы базовых релокаций}
  \label{tab:fixup_field}
\end{table}

